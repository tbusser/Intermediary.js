!function(a,b){"use strict";"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.Intermediary=b()}(this,function(){"use strict";function a(b){for(var c in b._channels)b._channels.hasOwnProperty(c)&&(a(b._channels[c]),delete b._channels[c]);b.removeSubscriber()}function b(a,b){if(null==a||""===a)return null;for(var c=g,d=a.split(":"),e=0,f=d.length;f>e&&null!=c;){if(c.hasChannel(d[e]))c=c.returnChannel(d[e]);else{if(b)break;c=c.addChannel(d[e])}e++}return""===c.namespace?null:c}function c(){var a=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function d(a,b){return a.options.priority>b.options.priority?-1:a.options.priority<b.options.priority?1:0}function e(a,b,d){this.id=c(),this.callback=a,this.context=b,this.options=d,this.channel=null}function f(a,b,c){this.namespace=a||"",this.id=c,this._subscribers=[],this._channels={},this._parent=b,this._stopped=!1}f.prototype={addChannel:function(a){var b=(""===this.namespace?"":this.namespace+":")+a,c=new f(b,this,a);return this._channels[a]=c,c},addSubscriber:function(a,b,c){null==c&&(c={}),c.priority=null==c.priority?0:0|c.priority;var f=new e(a,b,c);return f.channel=this,this._subscribers.push(f),this._subscribers.sort(d),f},autoRemoveChannel:function(){if(0===this._subscribers.length){for(var a in this._channels)if(this._channels.hasOwnProperty(a))return;null!=this._parent&&this._parent.removeChannel(this.id)}},hasChannel:function(a){return this._channels.hasOwnProperty(a)},publish:function(a){for(var b=0,c=this._subscribers.length,d=c;c>b;){var e=!1,f=this._subscribers[b],g=f.options;e=null!=g&&null!=g.predicate?g.predicate.apply(f.context,a):!0,e&&(null!=g&&null!=g.calls&&(g.calls--,g.calls<1&&this.removeSubscriber(f.id)),f.callback.apply(f.context,a),this._subscribers.length!=d&&(b-=d-this._subscribers.length,d=c=this._subscribers.length)),b++}null!=this._parent&&this._parent.publish(a)},removeChannel:function(a){this.hasChannel(a)&&(this._channels[a]=null,delete this._channels[a],this.autoRemoveChannel())},removeSubscriber:function(a){var b=!1,c=0,d=0;if(null==a){for(c=0,d=this._subscribers.length;d>c;c++)this._subscribers[c].channel=null;this._subscribers=[],b=!0}else for(c=this._subscribers.length-1;c>=0&&!b;)this._subscribers[c].id===a&&(this._subscribers[c].channel=null,b=!0,this._subscribers.splice(c,1)),c--;return this.autoRemoveChannel(),b},returnChannel:function(a){return this._channels[a]},returnSubscriber:function(a){for(var b,c=this._subscribers.length-1;c>=0&&null==b;)this._subscribers[c].id===a&&(b=this._subscribers[c]),c--;return b},setSubscriberPriority:function(a,b){var c=this.returnSubscriber(a);return null==c?!1:(c.options.priority=0|b,this._subscribers.sort(d),!0)}};var g=new f("");return{getSubscriber:function(a,c){var d=b(a,!0);return null==d||d.namespace!==a?null:d.returnSubscriber(c)},once:function(a,b,c,d){return d=d||{},d.calls=1,this.subscribe(a,b,c,d)},publish:function(a){var c=b(a,!0);if(null==c)return null;var d=Array.prototype.slice.call(arguments,1);return 0===d.length&&d.push(null),d.push(a),c.publish(d),!0},reset:function(){a(g)},setSubscriberPriority:function(a,c,d){var e=b(a,!0);return null==e||e.namespace!=a?null:e.setSubscriberPriority(c,d)},subscribe:function(a,c,d,e){var f=b(a,!1);return null==f||f.namespace!=a?null:(d=d||{},e=e||{},f.addSubscriber(c,d,e).id)},unsubscribe:function(a,c){var d=b(a,!0);return null==d||d.namespace!==a?null:d.removeSubscriber(c)}}});